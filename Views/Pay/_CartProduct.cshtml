@using WoodyIconShopModel.Models
@model WoodyIconShopModel.Models.Cart.Cart

@{
    int count = 1;
    //int totalBalance = 0; //總金額
    ShopConfig shopConfig = ViewBag.shopConfig;
    //List<Company> companylist = (List<Company>)ViewBag.Company;
}

@foreach (var compy in ViewBag.Company)
{
    //20171127 改成每個公司個別計算
    int totalBalance = 0;
    //運費
    int needShippingfee = 0;

    <div class="form-box">
        <!-- 標題內容，mob版會隱藏 -->
        <h4 class="order-title"><i class="fa fa-archive" aria-hidden="true"></i>&nbsp;@compy.Name</h4>
        <hr />
        <div class="row hidden-xs shop-table-title">
            <div class="col-xs-4 col-sm-1">商品圖片</div>
            <div class="col-xs-8 col-sm-11">
                <div class="row">
                    <div class="col-sm-4">商品名稱</div>
                    <div class="col-sm-2 text-right">單價</div>
                    <div class="col-sm-3">數量</div>
                    <div class="col-sm-2 text-right">小計</div>
                    <div class="col-sm-1"></div>
                </div>
            </div>
        </div>

        <!--
            需程式協助
            需新增贈品、加購於列表中，不顯示圖片，品名顯示為：
            贈品：品名
            加購：品名
            隱藏贈品與加購之【單價】與【數量調整鈕】
        -->
        <!-- 列表內容 -->
        @foreach (var cartitem in Model.Where(s => s.Dealer == compy.Id).OrderBy(c => c.Type))
        {
            decimal price = 0;
            switch (cartitem.Type)
            {
                case CartType.Product:
                    price = ProductPresenter.GetPrice(cartitem.product);
                    break;
                case CartType.Gift:
                    price = 0;
                    break;
                case CartType.Purchase:
                    price = cartitem.Price;
                    break;
                case CartType.TotalGift:
                    price = 0;
                    break;
                case CartType.TotalPurchase:
                    price = cartitem.Price;
                    break;
            }
            totalBalance += Convert.ToInt32(price * cartitem.Quantity);

            <div class="row shop-table-body">
                <div class="col-xs-4 col-sm-1">
                    @{
                        WoodyIconShopModel.Models.ProductImage image = cartitem.product.ProductImage.Where(pi => pi.Main && pi.ImageSetting != null && pi.ImageSetting.IsEnable).FirstOrDefault();
                        string imageurl = Url.Content("~/Content/images/transparent.png");
                        if (image != null)
                        {
                            imageurl = Url.Content(shopConfig.ServerImgPath + image.ImageSetting.Name);
                        }
                    }
                    <img class="img-responsive" src="@imageurl">
                </div>
                <div class="col-xs-8 col-sm-11">
                    <div class="row">
                        <div class="col-sm-4"><a target="_blank" href="@Url.Action("ProductDetail", "Product", new { Id = cartitem.product.Id })">@cartitem.product.Name</a></div>
                        <input type='hidden' value='@cartitem.Id' id='no_@count' />
                        <input type='hidden' value='@((int)cartitem.Type)' id='type_@count' />
                        <input type='hidden' value='@cartitem.TypeId' id='typeid_@count' />
                        <input type='hidden' value='@cartitem.ParentProductId' id='parentid_@count' />
                        <div class="col-sm-2 text-right">
                            <span class="shop_cart-list-tag">單價：</span>
                            <div id='price_@count'>
                                $@string.Format("{0:n0}", price)
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class='input-group'>
                                @{
                                    string disabled = (cartitem.Type == CartType.Gift || cartitem.Type == CartType.TotalGift) ? "disabled" : "";
                                }
                                <span class='input-group-btn'>
                                    <button class='btn btn-secondary' type='button' onclick='decreaseBuyNumber(@count)' @disabled>-</button>
                                </span>
                                <input type="number" value='@cartitem.Quantity' id='number_add_cart_@count' class='form-control cartquantity' style="min-width:40px" placeholder='數量' @disabled>
                                <span class='input-group-btn'>
                                    <button class='btn btn-secondary' type='button' onclick='increaseBuyNumber(@count)' @disabled>+</button>
                                </span>
                            </div>
                            <input type='hidden' value='@cartitem.product.Stock' id='warehouse_@count' />
                        </div>
                        <div class="col-sm-2 text-right"><span class="shop_cart-list-tag">小計：</span><div id='Cost_@count' class='vTotal'>$@string.Format("{0:n0}", price * cartitem.Quantity)</div></div>
                        <div class="col-sm-1">
                            @if (cartitem.Type != CartType.Gift && cartitem.Type != CartType.TotalGift)
                            {
                                <a class="btn btn-default btn-xl pull-right" href='javascript: if(confirm("確定要移除此商品?")) {RemoveFromCart($("#no_@count").val(), "@((int)cartitem.Type)", "@cartitem.TypeId", "@cartitem.ParentProductId");} '>移除</a>
                            }
                        </div>
                    </div>
                </div>
            </div>
                                        count++;
                                    }

        <hr />
        <div class="row shop-table-footer text-right">
            <div class="col-sm-1 hidden-xs"></div>
            <div class="col-xs-12 col-sm-11">
                <div class="row">
                    <!--免運提示-->
                    @if (ViewBag.ShipCost != null && ViewBag.ShipCost.CostRangeEnd != 0)
                    {
                        int need = ViewBag.ShipCost.CostRangeEnd - totalBalance;
                        if (need > 0)
                        {
                            <div class="col-xs-12 col-sm-11" style="overflow:hidden"><span class="free-shipping-tip">尚需$@(need)符合免運優惠</span></div>
                            <div class="col-sm-1 hidden-xs"></div>
                        }
                    }                 
                </div>
            </div>
        </div>
        <div class="row shop-table-footer text-right">
            <div class="col-sm-1 hidden-xs"></div>
            <div class="col-xs-12 col-sm-11">
                <div class="row">
                    <div class="col-xs-6 col-sm-9">價格小計</div>
                    <div class="col-xs-6 col-sm-2">$<div id="subtotalmoney" style="display:inline">@String.Format("{0:n0}", totalBalance)</div></div>
                    <div class="col-sm-1 hidden-xs"></div>
                </div>
            </div>
        </div>
        <div class="row shop-table-footer text-right">
            <div class="col-sm-1 hidden-xs"></div>
            <div class="col-xs-12 col-sm-11">
                <div class="row">
                    <div class="col-xs-6 col-sm-9">運費</div>
                    @if (ViewBag.ShipCost != null && ViewBag.ShipCost.CostRangeEnd != 0)
                    {
                        int need = ViewBag.ShipCost.CostRangeEnd - totalBalance;
                        if (need > 0)  // 2020/04/29, lozenlin, comment, 剛好是設定值上限金額時就免運費
                        {
                            needShippingfee = ViewBag.ShipCost.Shippingfee;
                        }
                    }
                    <div class="col-xs-6 col-sm-2">$@(needShippingfee)</div>
                    <div class="col-sm-1 hidden-xs"></div>
                </div>
            </div>
        </div>
        @*<div class="row shop-table-footer text-right">
            <div class="col-sm-1 hidden-xs"></div>
            <div class="col-xs-12 col-sm-11">
                <div class="row">
                    @*點選後彈出視窗，選擇折扣
                    <div class="col-xs-6 col-sm-9"><a href='#modal-id' data-toggle="modal" class="btn btn-primary">使用折扣券</a>&nbsp;折扣</div>
                    <div class="col-xs-6 col-sm-2">-$0</div>
                    <div class="col-sm-1 hidden-xs"></div>
                </div>
            </div>
        </div>*@
        <hr />
        <div class="row shop-table-footer text-right">
            <div class="col-sm-1 hidden-xs"></div>
            <div class="col-xs-12 col-sm-11">
                <div class="row">
                    <div class="col-xs-6 col-sm-9">總計</div>
                    <div class="col-xs-6 col-sm-2">$<div id="totalmoney" style="display:inline">@String.Format("{0:n0}", (totalBalance + needShippingfee))</div></div>
                    <div class="col-sm-1 hidden-xs"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-id">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">共有 X 張可使用的折價券</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>折價券名稱</th>
                                <th>有效日</th>
                                <th>折價券面額</th>
                                <th>折價後金額</th>
                                <th>選取</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>會員專屬$50折價券(滿350元可使用)</td>
                                <td>10/22</td>
                                <td>200</td>
                                <td>3000</td>
                                <td>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="" id="input" value="" checked="checked">
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">不使用</button>
                    <button type="button" class="btn btn-primary">確定</button>
                </div>
            </div>
        </div>
    </div>
                                    }


